

## 1. FLVHeader
所有 FLV 格式文件都以 FLVHeader 开头

| 字段       | 类型 | 说明                                                              |
|:-----------|:-----|:------------------------------------------------------------------|
| Signature  | UI8  | 'F' (0x46)                                                        |
| Signature  | UI8  | 'L' (0x4C)                                                        |
| Signature  | UI8  | 'V' (0x56)                                                        |
| Version    | UI8  | FLV 版本。例如，0x01 表示 FLV 版本 1                              |
| TypeFlags  | UI8  | b[0] 是否存在视频流<br>b[2] 是否存在音频流<br>其他字段保留，值为0 |
| DataOffset | UI32 | FLV Header 长度(字节)                                             |
FLV版本1中，“数据偏移”字段值为9。在FLV未来版本中，此字段可兼容更大尺寸的 FLVHeader。

## 2. FLVBody
一个 FLV 文件，除开头的 FLVHeader外，剩余部分就是 FLVBody。FLVBody 由一系列 back-pointer 和 tag 交织构成。back-pointer 表示前一 tag 大小。如下表所示：

| 字段               | 类型   | 说明                                                                                  |
|:-------------------|:-------|:--------------------------------------------------------------------------------------|
| PreviousTagSize0   | UI32   | 值总为0                                                                               |
| Tag1               | FLVTAG | 第一个Tag                                                                             |
| PreviousTagSize1   | UI32   | 前一tag大小，包含Tag头，单位字节。FLV 版本 1 中, 此值等于 11 乘以前一 Tag 的 DataSize |
| Tag2               | FLVTAG | 第二个Tag                                                                             |
| ...                | ...    | ...                                                                                   |
| PreviousTagSizeN-1 | UI32   | 倒数第二个Tag大小，包含Tag头大小，单位字节                                            |
| TagN               | FLVTAG | 最后一个Tag                                                                           |
| PreviousTagSizeN   | UI32   | 最后一个Tag的大小，包含Tag头大小，单位字节                                            |

```
typedef struct {
    UI32 PreviousTagSize0;
    FLVTAG Tag1;
    UI32 PreviousTagSize1;
    FLVTAG Tag2;
    ...
    UI32 PreviousTagSizeN-1;
    FLVTAG TagN;
    UI32 PreviousTagSizeN;
}   FLVBODY;
```

## 3. FLVTag
FLVTag 包含音频、视频或脚本元数据、可选的加密元数据和payload。FLVTag 指对象，则其类型是 FLVTAG，定义如下：

| 字段              | 类型   | 说明                                                                                                                                        |
|:------------------|:-------|:--------------------------------------------------------------------------------------------------------------------------------------------|
| Reserved          | UB [2] | 用于 FMS 的保留字段, 值为 0                                                                                                                 |
| Filter            | UB [1] | 指示 packet 是否需要预处理。<br>0 = 不需要预处理。<br>1 = packet 在渲染前需要预处理(例如解密)。<br>未加密文件中此值为0，加密文件中此值为1。 |
| TagType           | UB [5] | 8 = 音频<br>9 = 视频<br>18 = 脚本数据                                                                                                       |
| DataSize          | UI24   | Tag数据区长度。Tag中从 StreamID 后到Tag结尾处的字节数 (等于 Tag 长度 – 11)                                                                  |
| Timestamp         | UI24   | 当前 Tag 的时间戳，单位是毫秒。此值为相对值，FLV 文件中第一个 Tag 的时间戳总为 0                                                            |
| TimestampExtended | UI8    | 和时间戳字段一起构成一个32位值, 此字段为高 8 位, 时间戳字段为低24位. 单位毫秒                                                               |
| StreamID          | UI24   | 总为 0.                                                                                                                                     |
| Header            | IF TagType == 8<br>AudioTagHeader<br>IF TagType == 9<br>VideoTagHeader                         | 音频或视频 TagHeader，注意脚本没有 TagHeader        |
| IF Filter == 1<br>EncryptionHeader| IF Filter == 1<br>EncryptionTagHeader                                          | 采用加密时包含此字段  TODO                          |
| IF Filter == 1<br>FilterParams    | IF Filter == 1<br>FilterParams                                                 | 采用加密时包含此字段  TODO                          |
| Data              | IF TagType == 8<br>AUDIODATA<br>IF TagType == 9<br>VIDEODATA<br>IF TagType == 18<br>SCRIPTDATA | 音频、视频或脚本 TagBody，注意区分加密与非加密      |

FLVTAG 数据结构伪代码示意如下：
```
typedef struct {
    UB[2] Reserved;
    UB[1] Filter;
    UB[5] TagType;
    UI24 DataSize;
    UI24 Timestamp;
    UI8 TimestampExtended;
    UI24 StreamID;
  IF TagType == 8
    AudioTagHeader Header;
  IF TagType == 9
    VideoTagHeader Header;
  IF Filter == 1
    EncryptionTagHeader EncryptionHeader;
  IF Filter == 1
    FilterParams FilterParams;
  IF TagType == 8
    AUDIODATA Data;
  IF TagType == 9
    VIDEODATA Data;
  IF TagType == 18
    SCRIPTDATA Data;
}   FLVTAG;
```

### 3.1 Audio Tag
Audio Tag 包括 AudioTagHeader 和 AudioTagBody 两部分。

#### 3.1.1 AudioTagHeader

| 字段          | 类型   | 说明                                                                                    |
|:--------------|:-------|:----------------------------------------------------------------------------------------|
| SoundFormat   | UB [4] | 声音格式：<br>0 = Linear PCM, platform endian<br>1 = ADPCM<br>2 = MP3<br>3 = Linear PCM, little endian<br>4 = Nellymoser 16-kHz mono<br>5 = Nellymoser 8-kHz mono<br>6 = Nellymoser<br>7 = G.711 A-law logarithmic PCM<br>8 = G.711 mu-law logarithmic PCM 9 = reserved<br>10 = AAC<br>11 = Speex<br>14 = MP3 8-Khz<br>15 = Device-specific sound|
| SoundRate     | UB [2] | 采样率：<br>AAC: 总为3<br>0 = 5.5 kHz<br>1 = 11 kHz<br>2 = 22 kHz<br>3 = 44 kHz         |
| SoundSize     | UB [1] | 采样位深。此参数仅适用未压缩格式，压缩格式总在内部被解码为16位。<br>0 = 8位<br>1 = 16位 |
| SoundType     | UB [1] | 0 = 单声道<br>1 = 立体声                                                                |
| IF SoundFormat == 10<br>AACPacketType | UI8 | AAC帧类型。仅当声音格式为 10 时，存在此字段<br>0 = AAC sequence header<br>1 = AAC raw |

格式 3，linear PCM，存储原始 PCM 采样点。如果采样位深为 8，采样点数据为无符号型。如果采样位深为 16，采样点数据为小端存储的带符号型。如果是立体声，左右声道采样点交织存放：左-右-左-右-...

格式 0 与格式 3 的不同之处只有一点：格式 0 存储 16 位采样数据，采用的大小端顺序是创建 FLV 文件的平台所使用的大小端顺序。因此，不应使用格式 0，而应使用格式 3。

格式 4 (Nellymoser 16-kHz mono) 和格式 5 (Nellymoser 8 kHz mono)，是两种特殊情况, 因为采样率字段无法表示 8 kHz 和 16 kHz。当采样格式是格式 4 或格式 5 时，Flash 播放器会忽略采样率和声音类型两个字段。对于其他采样率的 Nellymoser 格式, 即格式 6，则正常使用采样率和声音类型两个字段。

格式 10，AAC，声音类型应为 1 (立体声) 且采样率应为 3 (44 kHz)。这并不表示 FLV 中的 AAC 音频总是立体声、44 kHz的数据。实际上，Flash 播放器会忽略这两个值，而从已编码的 AAC 位流中提取出声道数和采样率信息。

格式 11，Speex，音频以 16 kHz采样率压缩为单声道，采样率字段值应为 0，采样位深字段值应为 1，声音类型字段值应为 0。

格式 7，8，14 和 15 保留。

```
typedef struct {
    UB [4] SoundFormat;
    UB [2] SoundRate;
    UB [1] SoundSize;
    UB [1] SoundType;
  IF SoundFormat == 10
    UI8 AACPacketType;
}
```

#### 3.1.2 AudioTagBody/AUDIODATA
如果采用了加密，则是加密的 AudioTagBody，参考规范文档“附件 F. FLV 加密”章节获得详细信息，此处不详述。如果未采用加密，则是普通的 AudioTagBody。如果音频 Tag Header 中声音格式为 10，则为 AAC 音频数据，待补充。

### 3.2 Video Tag

#### 3.2.1 VideoTagHeader

| 字段            | 类型 | 说明                                          |
|:----------------|:-----|:----------------------------------------------|
| FrameType      | UB [4]    | 帧类型<br>1: keyframe (for AVC, a seekable frame) <br>2: inter frame (for AVC, a non-seekable frame)<br>3: disposable inter frame (H.263 only)<br>4: generated keyframe (reserved for server use only)<br>5: video info/command frame|  
| CodecID         | UB [4]    | 编解码器标识：<br>1: JPEG (currently unused) <br>2: Sorenson H.263<br>3: Screen video<br>4: On2 VP6<br>5: On2 VP6 with alpha channel<br>6: Screen video version 2<br>7: AVC|  
| IF CodecID == 7<br>AVCPacketType | UI8    | AVC帧类型：<br>0 = AVC sequence header<br>1 = AVC NALU<br>2 = AVC end of sequence (lower level NALU sequence ender is not required or supported)|
| IF CodecID == 7<br>CompositionTime | UI24   | 待补充           |

H.264 的命名遵循了 ITU-T 的命名约定，它是 VCEG 视频编码标准 H.26x 线中的一员；MPEG-4 AVC 的命名来自 ISO/IEC MPEG 的命名约定，它是 ISO/IEC 14496 的第 10 部分，该协议族被称为 MPEG-4。

#### 3.2.2 VideoTagBody/VIDEODATA
如果采用了加密，则是加密的 VideoTagBody，参考规范文档“附件 F. FLV 加密”章节获得详细信息，此处略。如果未采用加密，则是普通的 VideoTagBody，参考如下。

VideoTagBody 包含视频帧净荷数据。

| 字段         | 长度 | 说明 |
|:-------------|:-----|:-----|
| VideoTagBody | ...  | ...  |

### 3.3 Data Tag
数据 Tag 封装了单一方法，此方法通常在 Flash 播放器中的网络流对象上被调用。数据 Tag 包含方法名和一组参数。

#### 3.3.1 ScriptTagBody/SCRIPTDATA
SCRIPTDATA 包含 Body 字段。如果采用了加密，Body 的类型是 EncryptedBody，可参考规范文档“附件 F. FLV 加密”章节获得详细信息，此处略。如果未采用加密，则 Body 的类型是 ScriptTagBody，下面详述。
```
typedef struct {
  IF Encrypted
    EncryptedBody Body
  else
    ScriptTagBody Body;
}   SCRIPTDATA;
```

ScriptTagBody 包含以 AMF(Action Message Format) 编码的 SCRIPTDATA。AMF 是一种紧凑二进制格式，用于序列化 ActionScript 对象图。ScriptTagBody 定义如下：

| 字段  | 类型            | 说明               |
|:------|:----------------|:-------------------|
| Name  | SCRIPTDATAVALUE | 方法名或对象名     |
| Value | SCRIPTDATAVALUE | AMF 参数或对象属性 |
这里的 Name 就是上面提到的数据 Tag 中的方法名，Value 是此方法的一组参数。

ScriptTagBody 数据结构伪代码示例如下：
```
typedef struct {
    SCRIPTDATAVALUE Name;
    SCRIPTDATAVALUE Value;
}   ScriptTagBody;
```

#### 3.3.2 SCRIPTDATAVALUE
一个 SCRIPTDATAVALUE 记录包含一个特定类型的 ActionScript 值。

| 字段  | 类型            | 说明               |
|:------|:----------------|:-------------------|
|Type |UI8 | ScriptDataValue 的类型：<br>0 = Number<br>1 = Boolean<br>2 = String<br>3 = Object<br>4 = MovieClip (保留，不支持)<br>5 = Null<br>6 = Undefined<br>7 = Reference<br>8 = ECMA array<br>9 = Object end marker<br>10 = Strict array<br>11 = Date<br>12 = Long string |
|ScriptDataValue| Type 字段值 -> 本字段类型：<br>0 -> DOUBLE<br>1 -> UI8<br>2 -> SCRIPTDATASTRING<br>3 -> SCRIPTDATAOBJECT<br>7 -> UI16<br>8 -> SCRIPTDATAECMAARRAY<br>10 -> SCRIPTDATASTRICTARRAY<br>11 -> SCRIPTDATADATE<br>12 -> SCRIPTDATALONGSTRING| 脚本数据值 |
SCRIPTDATAVALUE 的两个字段，Type 是类型，ScriptDataValue 是值。Type 的值确定 ScriptDataValue 的类型。因为 ScriptDataValue 的类型是动态的，由运行时解析得到的 Type 的值确定，所以这里类型和值用了两个字段。如果是静态类型，显然只用一个字段就可以了。

SCRIPTDATAVALUE 数据结构伪代码示例如下：
```
typedef struct {
    UI8 Type;
  IF Type == 0
    DOUBLE ScriptDataValue;
  IF Type == 1
    UI8 ScriptDataValue;
  IF Type == 2
    SCRIPTDATASTRING ScriptDataValue;
  IF Type == 3
    SCRIPTDATAOBJECT ScriptDataValue;
  IF Type == 7
    UI16 ScriptDataValue;
  IF Type == 8
    SCRIPTDATAECMAARRAY ScriptDataValue;
  IF Type == 10
    SCRIPTDATASTRICTARRAY ScriptDataValue;
  IF Type == 11
    SCRIPTDATADATE ScriptDataValue;
  IF Type == 12
    SCRIPTDATALONGSTRING ScriptDataValue;
}   SCRIPTDATAVALUE;
```
3.3.1 节中 Name 字段和 Value 字段的类型都是SCRIPTDATAVALUE。Name 表示方法名，实际类型通常是SCRIPTDATASTRING。Value 字段表示方法的一组参数，实际类型通常是SCRIPTDATAECMAARRAY。后文将介绍 SCRIPTDATASTRING 和 SCRIPTDATAECMAARRAY 两种类型。其他类型略，详情可参考 FLV 规范文档。

#### 3.3.3 SCRIPTDATASTRING
SCRIPTDATASTRING 和 SCRIPTDATALONGSTRING 两种类型用于存储字符串，二者可存储字符串长度不同，SCRIPTDATASTRING 用于存储不超过 65535 个字符的字符串。

| 字段         | 类型   | 说明                                 |
|:-------------|:-------|:-------------------------------------|
| StringLength | UI16   | StringData 字段的长度，单位字节。    |
| StringData   | STRING | 字符串实际数据，注意不带结束符 NUL。 |

```
typedef struct {
    UI16 StringLength;
    STRING StringData;
}   SCRIPTDATASTRING;
```

#### 3.3.4 SCRIPTDATAECMAARRAY

SCRIPTDATAECMAARRAY 记录存储 ECMA 数组(下表中的 Variables 字段)。ECMA 数组是一个关联数组，应在 ActionScript 数组包含无序索引时使用。所有索引(无序或有序)都是字符串而不是整数。出于序列化的目的，SCRIPTDATAECMAARRAY 类型与匿名 ActionScript 对象非常相似。

| 字段            | 类型                       | 说明                               |
|:----------------|:---------------------------|:-----------------------------------|
| ECMAArrayLength | UI32                       | ECMA 数组元素数量(近似)            |
| Variables       | SCRIPTDATAOBJECTPROPERTY[] | 变量名和变量值的列表，即 ECMA 数组 |
| ListTerminator  | SCRIPTDATAOBJECTEND        | 列表终止符                         |

```
typedef struct {
    UI32 ECMAArrayLength;
    SCRIPTDATAOBJECTPROPERTY[] Variables;
    SCRIPTDATAOBJECTEND ListTerminator;
}   SCRIPTDATAECMAARRAY;
```

其中，SCRIPTDATAOBJECTPROPERTY 类型定义了 ActionScript 对象或关联数组变量的对象属性。
| 字段         | 类型             | 说明                     |
|:-------------|:-----------------|:-------------------------|
| PropertyName | SCRIPTDATASTRING | 对象属性或变量的名称     |
| PropertyData | SCRIPTDATAVALUE  | 对象属性或变量的值和类型 |
```
typedef struct {
    SCRIPTDATASTRING PropertyName;
    SCRIPTDATAVALUE PropertyData;
}   SCRIPTDATAOBJECTPROPERTY;
```

#### 3.3.5 实例：onMetaData 对象

FLV 元数据对象应在名为 onMetadata 的 SCRIPTDATA 标签中携带。各种属性对通过 NetStream.onMetaData 属性运行的 ActionScript 程序有效。可用的属性根据创建 FLV 文件的软件而有所不同。典型属性包括：

| 字段            | 类型    | 说明                             |
|:----------------|:--------|:---------------------------------|
| audiocodecid    | Number  | 音频编解码器 ID                  |
| audiodatarate   | Number  | 音频码率，单位 kbps              |
| audiodelay      | Number  | 由音频编解码器引入的延时，单位秒 |
| audiosamplerate | Number  | 音频采样率                       |
| audiosamplesize | Number  | 音频采样点尺寸                   |
| canSeekToEnd    | Boolean | 指示最后一个视频帧是否是关键帧   |
| creationdate    | String  | 创建日期与时间                   |
| duration        | Number  | 文件总时长，单位秒               |
| filesize        | Number  | 文件总长度，单位字节             |
| framerate       | Number  | 视频帧率                         |
| height          | Number  | 视频高度，单位像素               |
| stereo          | Boolean | 音频立体声标志                   |
| videocodecid    | Number  | 视频编解码器 ID                  |
| videodatarate   | Number  | 视频码率，单位 kbps              |
| width           | Number  | 视频宽度，单位像素               |

onMetaData 标签通常会成为 FLV Body 中的第一个标签，紧跟在 FLV Header 之后。onMetaData 标签中存储的是一些视频、音频及文件相关的元数据信息：如视频帧率，音频采样率、文件长度等。

结合 3.3.1 节，onMetaData 标签的 Name 字段主要就是存储 “onMetaData” 字符串。具体为：第 1 个字节值是 0x02，表示 Name 字段是字符串类型。第 2-3 个字节为 UI16 类型值，标识字符串的长度，值为 0x000A (“onMetaData” 这个字符串的长度)。后面跟着的数据为具体的字符串，值为 “onMetaData”。

onMetaData 标签的 Value 字段存储上表所示的各属性键值对。具体为：第 1 个字节值是 0x08，表示 Value 字段是数组类型。第 2-5 个字节为UI32类型值，表示数组元素个数。后面紧跟着数组，数组元素为属性名称和值组成的对(键值对)。最后是数组的结束符。

```
ScriptTagBody onMetaData;

onMetaData.Name.Type == 0x02
onMetaData.Name.ScriptDataValue.StringLength == 0x000A
onMetaData.Name.ScriptDataValue.StringData == "onMetaData"

onMetaData.Value.Type == 0x08
onMetaData.Value.ScriptDataValue.ECMAArrayLength == 
onMetaData.Value.ScriptDataValue.Variables[0].PropertyName == {0x0005, "width"}   // SCRIPTDATASTRING 类型
onMetaData.Value.ScriptDataValue.Variables[0].PropertyData == {0x00, 1280.0}      // SCRIPTDATAVALUE 类型
onMetaData.Value.ScriptDataValue.Variables[1].PropertyName == {0x0005, "height"}  // SCRIPTDATASTRING 类型
onMetaData.Value.ScriptDataValue.Variables[1].PropertyData == {0x00, 720.0}       // SCRIPTDATAVALUE 类型
...
```
