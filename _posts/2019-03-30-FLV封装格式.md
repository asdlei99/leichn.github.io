

## 1. FLV Header  
所有 FLV 格式文件都以 FLV Header 开头

| 字段     | 长度 | 说明                                                              |
|:---------|:-----|:------------------------------------------------------------------|
| 签名     | 24   | 'FLV' (0x464C56)                                                  |
| 版本     | 8    | FLV 版本. 例如, 0x01 表示 FLV 版本 1                              |
| 类型标志 | 8    | b[0] 是否存在视频流<br>b[2] 是否存在音频流<br>其他字段保留, 值为0 |
| 数据偏移 | 32   | FLV Header 大小(字节)                                             |
FLV版本1中，“数据偏移”字段值为9。在FLV未来版本中，此字段可兼容更大尺寸的 FLV Header。

## 2. FLV Body
一个 FLV 文件，除开头的 FLV Header外，剩余部分就是 FLV Body。FLV Body由一系列 back-pointer 和 tag 交织构成。back-pointer 表示前一 Tag 大小。如下表所示：

| 字段       | 长度 | 说明                                                                                      |
|:-----------|:-----|:------------------------------------------------------------------------------------------|
| Tag0大小   | 32   | 值总为0                                                                                   |
| Tag1       | 变长 | 第一个Tag                                                                                 |
| Tag1大小   | 32   | 前一tag大小, 包含Tag头大小, 单位字节. FLV 版本 1中, 此值等于 11 乘以前一 Tag 的 DataSize. |
| Tag2       | 变长 | 第二个Tag                                                                                 |
| ...        | ...  | ...                                                                                       |
| TagN-1大小 | 32   | 倒数第二个Tag大小, 包含Tag头大小, 单位字节.                                               |
| TagN       | 变长 | 最后一个Tag                                                                               |
| Tag大小    | 32   | 最后一个Tag的大小, 包含Tag头大小, 单位字节.                                               |

## 3. FLV Tag
FLV Tag 包含音频、视频或脚本元数据、可选的加密元数据和payload。

| 字段       | 长度 | 说明                                                                                                                           |
|:-----------|:-----|:-------------------------------------------------------------------------------------------------------------------------------|
| 保留       | 2    | 用于 FMS 的保留字段, 值为 0                                                                                                    |
| 预处理     | 1    | 指示 packet 是否需要预处理. 0 = 不需要预处理. 1 = packet 在渲染前需要预处理(例如解密). 未加密文件中此值为0, 加密文件中此值为1. |
| Tag类型    | 5    | Tag类型: 8 = 音频, 9 = 视频, 18 = 脚本数据                                                                                     |
| 数据大小   | 24   | DataSize UI24 Length of the message. Number of bytes after StreamID to end of tag (Equal to length of the tag – 11)            |
| 时间戳     | 24   | 当前 Tag 的时间戳,单位是毫秒. 此值为相对值, FLV文件中第一个 Tag 的时间戳总为 0                                                 |
| 时间戳扩展 | 8    | 和时间戳字段一起构成一个32位值, 此字段为高 8 位, 时间戳字段为低24位. 单位毫秒                                                  |
| 流ID       | 24   | 总为 0.                                                                                                                        |
| 数据区     |      |                                                                                                                                |

### 3.1 音频 Tag
音频 Tag 包括音频 Tag Header 和音频 Tag Body 两部分。

#### 3.1.1 音频 Tag Header

| 字段      | 长度 | 说明                                                                                               |
|:----------|:-----|:---------------------------------------------------------------------------------------------------|
| 声音格式  | 4    | 0 = Linear PCM, platform endian<br>1 = ADPCM<br>2 = MP3<br>3 = Linear PCM, little endian<br>4 = Nellymoser 16-kHz mono<br>5 = Nellymoser 8-kHz mono<br>6 = Nellymoser<br>7 = G.711 A-law logarithmic PCM<br>8 = G.711 mu-law logarithmic PCM 9 = reserved<br>10 = AAC<br>11 = Speex<br>14 = MP3 8-Khz<br>15 = Device-specific sound|
| 采样率    | 2    | AAC: 总为3<br>0 = 5.5 kHz<br>1 = 11 kHz<br>2 = 22 kHz<br>3 = 44 kHz                                |
| 采样位深  | 1    | 每个音频采样点的位数. 此参数仅适用未压缩格式. 压缩格式总在内部被解码为16位.<br>0 = 8位<br>1 = 16位 |
| 声音类型  | 1    | 0 = 单声道<br>1=立体声                                                                             |
| AAC帧类型 | 8    | 仅当声音格式为 10 时, 存在此字段.<br>0 = AAC sequence header<br>1 = AAC raw                        |

格式 3，linear PCM，存储原始 PCM 采样点。如果采样位深为 8，采样点数据为无符号型。如果采样位深为 16，采样点数据为小端存储的带符号型。如果是立体声，左右声道采样点交织存放：左-右-左-右-...。

格式 0 与格式 3 的不同之处只有一点：格式 0 存储 16 位采样数据，采用的大小端顺序是创建 FLV 文件的平台所使用的大小端顺序。因此，不应使用格式 0，而应使用格式 3。

格式 4 (Nellymoser 16-kHz mono) 和格式 5 (Nellymoser 8 kHz mono)，是两种特殊情况, 因为采样率字段无法表示 8 kHz 和 16 kHz。当采样格式是格式 4 或格式 5 时，Flash 播放器会忽略采样率和声音类型两个字段。对于其他采样率的 Nellymoser 格式, 即格式 6，则正常使用采样率和声音类型两个字段。

格式 10，AAC，声音类型应为 1 (立体声) 且采样率应为 3 (44 kHz)。这并不表示 FLV 中的 AAC 音频总是立体声、44 kHz的数据。实际上，Flash 播放器会忽略这两个值，而从已编码的 AAC 位流中提取出声道数和采样率信息。

格式 11，Speex，音频以 16 kHz采样率压缩为单声道，采样率字段值应为 0，采样位深字段值应为 1，声音类型字段值应为 0。

格式 7，8，14 和 15 保留。

#### 3.1.2 音频 Tag Body
如果采用了加密，则是加密的 EncryptedBody，参考规范文档“附件 F. FLV 加密”章节获得详细信息。此处不详述。如果未采用加密，则是普通的 AudioTagBody。如果音频 Tag Header 中声音格式为 10，则为 AAC 音频数据，待。

### 3.2 视频 Tag

#### 3.2.1 视频 Tag Header

| 字段            | 长度 | 说明                                          |
|:----------------|:-----|:----------------------------------------------|
| Frame Type      | 4    | 帧类型<br>1: keyframe (for AVC, a seekable frame) <br>2: inter frame (for AVC, a non-seekable frame)
<br>3: disposable inter frame (H.263 only)<br>4: generated keyframe (reserved for server use only)<br>5: video info/command frame|
| CodecID         | 4    | 编解码器标识：<br>1: JPEG (currently unused) <br>2: Sorenson H.263<br>3: Screen video<br>4: On2 VP6<br>5: On2 VP6 with alpha channel<br>6: Screen video version 2<br>7: AVC|
| AVCPacketType   | 8    | CodecID 值为 7 时存在此字段，值定义如下：<br>0 = AVC sequence header<br>1 = AVC NALU<br>2 = AVC end of sequence (lower level NALU sequence ender is not required or supported)|
| CompositionTime | 24   | CodecID 值为 7 时存在此字段，待补充           |

H.264的命名遵循了ITU-T的命名约定，它是VCEG视频编码标准H.26x线中的一员；MPEG-4 AVC的命名来自ISO/IEC MPEG的命名约定，它是ISO/IEC 14496的第10部分，该协议族被称为MPEG-4。